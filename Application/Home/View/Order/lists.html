<extend name="Public/base" />
<block name="mycss">
    
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/assets/bootstrap-daterangepicker/daterangepicker.css" />

</block>
<block name="content">
  	<div class="row-fluid">
        <div class="span12">
            <!-- BEGIN BASIC PORTLET-->
            <div class="widget blue">
                <div class="widget-title">
                    <h4><i class="icon-reorder"></i> 订单列表</h4>
                <span class="tools">
                    <a data-toggle="modal" href="#example" id="amodelclick">送货提醒</a>
                    <a href="{:U('order/add')}">添加订单</a>
                    <a href="javascript:;" class="icon-chevron-down"></a>                   
                </span>
                </div>
                <div class="widget-body">
                    <form action="{:U('order/lists')}" class="form-vertical" method="get">
                        <div class="row-fluid">
                           <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">下单日期</label>
                                    <div class="controls controls-row">
                                    <input type="text" class="input-block-level" placeholder="依据日期区间搜索" id="dateCtime" name="ctime" value="<?php if(!empty($getParam['ctime'])){ echo $getParam['ctime'];}?>">
                                    </div>
                                </div>
                            </div>
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">送花日期</label>
                                    <div class="controls controls-row">
                                        <input type="text" class="input-block-level" placeholder="依据日期区间搜索" id="dateStime" name="stime" value="<?php if(!empty($getParam['stime'])){ echo $getParam['stime'];}?>">
                                    </div>
                                </div>
                            </div>
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">订单编号</label>
                                    <div class="controls controls-row">
                                        <input type="text" class="input-block-level" placeholder="依据订单编号搜索" name="oid" value="<?php if(!empty($getParam['oid'])){ echo $getParam['oid'];}?>">
                                    </div>
                                </div>
                            </div>
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">花集订单</label>
                                    <div class="controls controls-row">
                                        <input type="text" class="input-block-level" placeholder="依据花集订单搜索" name="flowerorder" value="<?php if(!empty($getParam['flowerorder'])){ echo $getParam['flowerorder'];}?>">
                                    </div>
                                </div>
                            </div>
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">会员号</label>
                                    <div class="controls controls-row">
                                        <input type="text" class="input-block-level" placeholder="依据会员号搜索" name="mid" value="<?php if(!empty($getParam['mid'])){ echo $getParam['mid'];}?>">
                                    </div>
                                </div>
                            </div>
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">花店名称</label>
                                    <div class="controls controls-row">
                                        <input type="text" class="input-block-level" placeholder="依据花店名称搜索" name="fshopname" value="<?php if(!empty($getParam['fshopname'])){ echo $getParam['fshopname'];}?>">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row-fluid">
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">订单来源</label>
                                    <div class="controls controls-row">
                                        <select class="input-block-level" tabindex="1" name="sid">
                                            <option value="0" <?php if($getParam['sid'] == 0){ echo 'selected="selected"';}?> >请选择</option>
                                            <foreach name="slists" item="vo">
                                            <option value="{$vo.id}" <?php if($getParam['sid'] == $vo['id']){ echo 'selected="selected"';}?>>{$vo.sname}</option>                                  
                                            </foreach>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">业务员</label>
                                    <div class="controls controls-row">
                                        <select class="input-block-level" tabindex="1" name="author">
                                            <option value="0" <?php if($getParam['author'] == 0){ echo 'selected="selected"';}?>>请选择</option>
                                            <foreach name="mlists" item="vo">
                                            <option value="{$vo.id}" <?php if($getParam['author'] == $vo['id']){ echo 'selected="selected"';}?> >{$vo.tname}</option>                                  
                                            </foreach>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">状态</label>
                                    <div class="controls controls-row">
                                        <select class="input-block-level" tabindex="1" name="status">
                                            <option value="0" <?php if($getParam['status'] == 0){ echo 'selected="selected"';}?> >请选择</option>
                                            <option value="2" <?php if($getParam['status'] == 2){ echo 'selected="selected"';}?> >故障</option>
                                            <option value="3" <?php if($getParam['status'] == 3){ echo 'selected="selected"';}?> >预约</option>
                                            <option value="4" <?php if($getParam['status'] == 4){ echo 'selected="selected"';}?> >完成</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">姓名</label>
                                    <div class="controls controls-row">
                                        <input type="text" class="input-block-level" placeholder="依据买/收姓名搜索" name="name" value="<?php if(!empty($getParam['name'])){ echo $getParam['name'];}?>">
                                    </div>
                                </div>
                            </div>
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">联系电话</label>
                                    <div class="controls controls-row">
                                        <input type="text" class="input-block-level" placeholder="依据买/收联系电话搜索" name="phone" value="<?php if(!empty($getParam['phone'])){ echo $getParam['phone'];}?>">
                                    </div>
                                </div>
                            </div>
                            <div class="span2">
                                <div class="control-group">
                                    <label class="control-label">地址</label>
                                    <div class="controls controls-row">
                                        <input type="text" class="input-block-level" placeholder="依据收货地址搜索" name="raddress" value="<?php if(!empty($getParam['raddress'])){ echo $getParam['raddress'];}?>">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <center><button type="submit" class="btn blue"><i class="icon-ok"></i> 搜索</button></center>
                        </div>
                    </form>
                    <table class="table table-striped table-bordered table-advance table-hover">
                        <thead>
                        <tr>
                            <th> 订单编号</th>
                            <th> 订单来源</th>
                            <th> 会员号</th>
                            <th> 姓名/电话</th>
                            <th> 地址</th>
                            <th> 送花日期</th>
                            <th> 下单时间</th>
                            <th> 花店名称</th>
                            <th> 业务员</th>
                            <th> 状态</th>
                        </tr>
                        </thead>
                        <tbody>
                        <foreach name="list" item="vo">
                        <tr>
                        <td><a href="<?php echo U('order/edit',array('id'=>$vo['id']));?>">{$vo.oid}</a></td>
                            <td>{$vo.sname}</td>
                            <td>{$vo.mid}</td>
                            <td>{$vo.receiver}/{$vo.rnumber}</td>
                            <td>{$vo.raddress}</td>
                            <td>{$vo.stime|date="Y-m-d H:i:s",###}</td>
                            <td>{$vo.ctime|date="Y-m-d H:i:s",###}</td>
                            <td><a href="http://sighttp.qq.com/msgrd?v=1&uin={$vo.flowerqq}" target="blank">{$vo.fshopname}</a>/{$vo.flowerphone}</td>
                            <td>{$vo.tname}</td>
                            <td>
                            	<switch name="vo.status" >
                            		<case value="2" break="2"><button class="btn btn-small btn-warning" title="故障">故障</button></case>
									<case value="3" break="3"><button class="btn btn-small btn-success" title="预定">预定</button></case>
									<case value="4" break="4"><button class="btn btn-small btn-danger" title="完成">完成</button></case>
									<default />未知状态
								</switch>
							</td>
                        </tr>
                        </foreach>
                        </tbody>
                    </table>
                    <center>{$page}</center>
                </div>
            </div>
            <!-- END BASIC PORTLET-->
        </div>
    </div>
    <div id="example" class="modal hide fade in" style="display: none; ">
            <div class="modal-header"> 
                <a class="close" data-dismiss="modal">×</a> 
                <h3>送货提醒</h3> 
            </div> 
            <div class="modal-body"> 
                <h4>请选择所需要配送的订单</h4>
                 <form method="post" id="sendpost" action="{:U('order/sendOrder')}">  
                    <div id="modalcontent">
                        <center>请稍后，数据加载中</center>
                    </div>
                </form> 
            </div> 
            <div class="modal-footer"> 
                <a href="javascript:void(0);" class="btn btn-success" id="sendposta">配送</a>
            </div>
    </div> 
</block>
<block name="myscript">
    <script type="text/javascript" src="__PUBLIC__/assets/bootstrap-daterangepicker/date.js"></script>
    <script type="text/javascript" src="__PUBLIC__/assets/bootstrap-daterangepicker/daterangepicker.js"></script>
    <script type="text/javascript">
        $('#dateCtime').daterangepicker({
            'format':'yyyyMMdd'
        });
        $('#dateStime').daterangepicker({
            'format':'yyyyMMdd'
        });
        <?php if(!isset($sendC) && empty($sendC)){?>
        window.setTimeout("refresh()",60000);
        function refresh(){ 
            location.reload();
        }
        <?php }else{ ?>
        $("#example").modal({show:true});
        getSendList();
        <?php } ?>
        $('#example').on('hidden.bs.modal', function (e) {
          window.setTimeout("refresh()",60000);
        });
        $('#sendposta').click(function() {
            $('#sendpost').submit();
        });
        $('#amodelclick').click(function(event) {
            getSendList();
        });
        function getSendList(){
            $.ajax({
                url:"{:U('order/getSendList')}",
                type:'get',
                datatype:'json',
                success:function(d){
                    if(d.status == 1){
                        var html = '';
                        $.each(d.list,function(n,m){
                            html += '<input type="checkbox" value="'+m.id+'" name="id[]"/>'+m.oid+'&nbsp;&nbsp;';
                        });
                        html += '</form>';
                        console.log(html);
                        $('#modalcontent').html(html);
                    }else{
                        $('#modalcontent').html(d.msg);
                    }
                }
            });
        }
    </script>
</block>